# 文件系统管理

## 一.硬盘结构

1. 硬盘的逻辑结构

   ![image-20210227112714006](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\image-20210227112714006.png)

2. dumpe2fs -h /dev/sda1,不加-h就是查看文件系统的块组信息

3. Linux常见的文件系统

   | 文件系统 | 描述                                                         |
   | -------- | ------------------------------------------------------------ |
   | ext      | Linux中最早的文件系统，由于在性能和兼容性上具有很多缺陷，现在已经很少使用 |
   | ext2     | 是ext文件系统的升级版本，Red Hat Linux 7.2版本以前的系统默认都是ext2文件系统，于1993年发布，支出最大16TB的分区和最大2TB的文件 |
   | ext3     | 是ext2文件系统的升级版本，最大的区别是带日志功能，以便在系统突然停止时提高文件系统的可靠性，支持最大16TB的分区和最大2TBde 文件 |
   | ext4     | 是ext3文件系统的升级版本，ext4在性能和可靠性方面进行了大量改进，ext4的变化可以说是翻天覆地的，比如向下兼容ext3,最大1EB文件系统和16TB文件，无限数量子目录，Extends连续数据库概念，多块分配，延迟分配，持久预分配，快速FSCK，日志校验，无日志模式，在线碎片整理，inode增强，默认启用barrier等。它是CentOS 6.x的默认文件系统 |
   | xfs      | XFS是最早针对IRIX操作系统开发，是一个高性能的日志文件系统，能够在断电以及操作系统崩溃的情况下保证文件系统数据的一致性，它是一个64位文件系统，后来进行开源并且移植到了Liunx操作系统中，目前CentOS 7.x将XFS+LVM作为默认的文件系统，据官方所称，XFS对于大文件的读写性能较好 |



# 二.常用的硬盘管理命令

   1. df命令

      ```shell
      df -ahT
      #-a显示特殊文件系统，这些文件系统几乎都是保存在内存中的，如/proc,因为是挂载在内存中，所以占用量都是0
      #-h单位不再只用KB，而是换成习惯单位
      #-T多出了文件系统类型一列
      df看的是空间大小（包括临时文件，垃圾文件）统计的剩余空间是准确的，du是用来统计文件大小，统计的文件大小是准确的，两个不一样
      lsof | grep deleted查看被删除的文件，然后一个进程一个进程的手工kill也是可以的
      设备文件名，挂载点
      ```

        2. du 命令

       ```shell
       du -h 文件名：列出这个文件下面所有文件的大小，以及所有文件占用内存的总和
       du -hs 文件名:加上s之后，只显示所有文件占用内存的总和
       
       #ls和ll不能统计目录大小或者目录大小不准确，会统计子文件的文件名占用内存的大小，不统计实际文件占用内存的大小
       #blokc大小有 1k,2k,4k默认是4k的
       ```

        3. fsck文件系统修复命令

       ```shell
       fsck -y /dev/sdb1,在系统开机的时候，会自动执行
       ```

        4. dumpe2fs显示磁盘状态

       ```shell
       dumpe2fs /dev/sda3
       dumpe2fs -h /dev/sda3加上-h是，表示只看超级块的信息
       ```

        5. 查看文件的详细时间

       ```shell
       stat test.sh
       ```

        6. ```shell
       type mkdir //mkdir is /bin/mkdir表示是内部命令
       type cd //cd is a shell builtin表示是外部命令
      
       file 文件名，是用来查看文件类型
      
       ```
      
       ```

# 三. fdisk命令手工分区

1. 查看系统所有硬盘及分区

   ```shell
   fdisk -l
   ```

2. 进行磁盘分区(分区还没有分区号)

   ```shell
   fdisk /dev/sdb
   #按m会出现交互页面
   #n开始新建分区
   #扩展分区里面不能写入数据，必须要分逻辑分区
   #格式化文件系统
   mkfs -t ext4 /dev/sdb1
   #挂载，创建挂载点
   #挂载分区
   mount /dev/sdb1/disk1/
   #用df -h来查看
   
   ```

   | 命令 | 说明                                                        |
   | ---- | ----------------------------------------------------------- |
   | a    | 设置可引导标记                                              |
   | b    | 编辑bsd磁盘标签                                             |
   | c    | 设置DOS操作系统兼容标记                                     |
   | d    | 删除一个分区                                                |
   | l    | 标记已知 的文件系统类型，82为linux  swap分区，83为Linux分区 |
   | m    | 显示帮助菜单                                                |
   | n    | 新建分区                                                    |
   | o    | 建立空白DOS分区表                                           |
   | p    | 显示分区列表                                                |
   | q    | 不保存退出                                                  |
   | s    | 建立空白SUN磁盘标签                                         |
   | t    | 改变一个分区的系统ID                                        |
   | u    | 改变显示记录单位                                            |
   | v    | 验证分区表                                                  |
   | w    | 保存退出                                                    |
   | x    | 附加功能(仅专家)                                            |

3. 重启电脑，用ifconfig命令看不到网卡的信息，重启网卡报错，可能是ip冲突，也可能是UUID冲突

   ```shell
   #解决方法
   #删除MAC地址行
   vi /etc/sysconfig/network-scripts/ifcfg-eth0
   #删除Mac地址和UUID绑定文件
   rm -rf /etc/udev/rules.d/70-presistent-net.rules
   #重启电脑
   reboot
   ```

4. 自动挂载

   ```shell
   #注意，此文件直接参与系统启动，如果修改错误，系统启动报错，开不了机
   vi /etc/fstab 
   #这个文件的形式
   /dev/sdb1   /disk1   ext3   defaults   1   2
   #第一列：设备文件名，也可以是硬盘的ID
   #第二列:挂载点
   #第三列:文件系统
   #第四列:挂载选项
   #第五列:是否备份
   #第六列:是否启动检查
   #查看硬盘的UUID号
   dumpe2fs /dev/sdb5或 ls -l /dev/disk/by-uuid/
   
   
   
   ```

# 四.文件系统管理-修复启动失败-当修改了/etc/fstab文件修改错了的时候

​    /etc/fstab/文件修复，前提是那到服务器本机

   如果在/etc/fstab的时候，提示不让修改，原因是没有写权限，只要把/分区重新挂载一下，挂载为读写权限就可以了，命令如下

mount  -o remount,rw /，把根分区挂载为读写





# 五.parted分区

# 六. 分配swap分区

1. 分区并修改为swap分区ID

         ```shell
fdisk  /dev/sdb
#拿/dev/sdb分区
Command (m for help)：t 修改分区的系统ID，swap分区的ID号是82
#可以按l来看分区的ID号
swap分区结束之后，需要格式化分区
mkswap /dev/sdb1
#将分区挂载到设备文件名上，这是临时生效的，如果要永久生效，需要在配置文件中配置，即让swap分区开机之后自动挂载
swapon /dev/sdb1
free -h
         ```











# 高级文件系统管理-LVM

## 一 磁盘配额

   1. 内核必须支持磁盘配额

      ```shell
      grep CONFIG_QUOTA /boot/config-2.6.32-279.e16.1686 CONFIG_QUOTA=y
      ```

     2. 系统中必须安装了quota工具，我们的linux默认是安装了quota工具的,查看命令如下

        ```shell
        rpm -qa |grep quota
        ```

     3. 要支持磁盘配额的分区必须开启磁盘配额功能，这个功能需要手工开启，不再是默认开启的

     4. 在分区上面开启磁盘配额功能

        ```shell
        #重新挂载/disk分区，并加入用户和用户组的磁盘配额功能
        mount -o remount,usrqutoa,grpquota /disk
        
        #我们想要永久生效，则需要修改/etc/fstab文件，改成:
        /dev/sdb1  /disk  ext4  defaults,usrquota,grpquota   0 0
        #修改配置文件如果想要生效，必须重启系统，负责也需要把分区重新挂载一遍
        ```

     5. 建立磁盘配额配置文件

        ```shell
        quotacheck [选项] [分区名]
        选项:
          -a:扫描/etc/mtab文件中所有启用磁盘配额功能的分区，如果加入此参数，命令后面就不需要加入分区名了
          -c:不管原有的配置文件，重新扫描并建立新的配置文件
          -u:建立用户配额的配置文件，也就是生成aquota,user文件
          -g：建立组配额的配置文件，会生成aquota,group文件
          -v:显示扫描过程
          -m:强制以读写的方式扫描文件系统，和-M类似，一般扫描跟分区时使用
          -f:强制扫描文件系统，并写入新的配置文件，一般扫描新添加的硬盘分区时使用
          
          
          
          quotacheck -avug
          #需要关联SELinux，负责会报错
          #查询当前Linux系统SELinux的状态
          getenforce
          setenforce 0关闭SELinux系统，0是关闭，1是开启
          #永久生效需要修改配置文件:/etc/selinux/config
        ```

        6. 设置用户和组的配额限制

           ```shell
           edquota [选项] [用户名和组名]
           edquota -u user1
           ```

        7. 启动和关闭配额

           配额的配置完成，接下来只需要启动配额就可以了，启动命令如下:

           ```shell
           quotaon [选项] [分区名]
           #选项
              -a:依据/etc/mtab文件启动所有的配额分区，如果不加-a，后面就一定要指定分区名
              -u:启动用户配额
              -g:启动组配额
              -v:显示启动过程信息
              -s:以习惯单位显示容量大小,如M,G
              
           quotaoff 关闭配额
           ```

        8. repquota查询文件系统配额

        9. 测试，这个地方不能用root用户测试，限制的是哪个用户就用哪个用户测试

           ```shell
           dd if=/dev/zero of=/disk/testfile bs=1M count=60  文件复制命令,每次复制1M，最多复制60M
           ```

        10. 配额复制

            user3用户的配额制和user2用户的完全一样，我们就可以使用user2用户作为模板进行复制，这样我们如果需要建立大量的配额值一致的用户时，就会非常方便，不用一个个手工建立了，复制命令如下:

            edquota -p user2 -u user3

            11. 非交互模式设定用户磁盘配额

                ```shell
                setquota -u 用户名  容量软限制  容量硬限制  个数限制  \
                #设定用户在/disk分区的容量软限制为10MB,文件个数限制5个，硬限制8个
                ```

            

            

            # 二.LVM逻辑卷管理

            1. 简介:LVM是Logical Volume Manager的简称，中文就是逻辑卷管理

            ​         物理卷(PV,Physical Volume):就是真正的物理硬盘或分区

            ​         卷组(VG,Volume Group):将多个物理卷合起来就组成了卷组，组成同一个卷组的物理卷可以是同一个硬盘的不同分区，也可以是不同硬盘上的不同分区，我们可以把卷组想象成为一个逻辑硬盘

            ​         逻辑卷(LV,Logical Volume):卷组是一个逻辑硬盘，硬盘必须分区之后才能使用，这个分区我们称作逻辑卷，逻辑卷可以格式化和写入数据。我们可以把逻辑卷想象成为分区。

            ​        物理扩展(PE,Physical Extend):PE是用来保存数据的最小单元，我们的数据实际上都是写入PE当中，PE的大小是可以配置的，默认是4MB

            2. 建立LVM的步骤:

               2.1 首先需要把物理硬盘分成分区，当然也可以是整块物理硬盘

               2.2 然后把物理分区建立成为物理卷(PV)，也可以把整块硬盘建立为物理卷

               2.3 接下来把物理卷整合成为卷组(VG)。卷组就已经可以动态的调整大小了，可以把物理分区加入卷		组，可可以把物理分区从卷组中删除

               2.4 最后就是把卷组再划分为逻辑卷(LV)，当然逻辑卷也是可以直接调整大小的。我们说逻辑卷可以想		象成为分区，所以也需要格式化和挂载

            标准分区不能修改大小，LVM分区支持修改大小，boot分区只能放在普通分区上面，不能用LVM分区

            

            

            

             

        

        

        

        

        

        

        

​     



















